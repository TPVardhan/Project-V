<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}Project V{% endblock %}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: radial-gradient(circle at top left, #111827 0, #020617 45%, #020617 100%); color: #e5e7eb; font-size: 15px; }
    a { color: inherit; text-decoration: none; }
    .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(14px); border-bottom: 1px solid rgba(15, 23, 42, 0.9); z-index: 30; }
    .top-left { display: flex; align-items: center; gap: 10px; }
    .top-left a { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 16px; text-decoration: none; color: inherit; transition: opacity 0.2s ease; }
    .top-left a:hover { opacity: 0.8; }
    .top-logo-dot { width: 20px; height: 20px; border-radius: 999px; background: radial-gradient(circle at 30% 30%, #38bdf8, #6366f1); box-shadow: 0 0 14px rgba(56, 189, 248, 0.7); }
    .top-nav { display: flex; align-items: center; gap: 18px; font-size: 14px; color: #9ca3af; }
    .top-nav a { padding: 6px 10px; border-radius: 999px; transition: all 0.2s ease; }
    .top-nav a:hover { background: rgba(15, 23, 42, 0.8); color: #e5e7eb; }
    .top-nav a.active { background: linear-gradient(135deg, #38bdf8, #6366f1); color: #f9fafb; font-weight: 600; }
    .bell-container { position: relative; }
    .top-bell { width: 36px; height: 36px; border-radius: 999px; border: 1px solid #1f2937; display: flex; align-items: center; justify-content: center; background: #020617; cursor: pointer; position: relative; color: #e5e7eb; font-size: 18px; transition: all 0.2s ease; padding: 0; }
    .top-bell:hover { border-color: #38bdf8; box-shadow: 0 0 8px rgba(56, 189, 248, 0.3); }
    .top-bell-dot { position: absolute; top: 2px; right: 2px; width: 10px; height: 10px; border-radius: 999px; background: #ef4444; display: none; }
    .top-bell-dot.active { display: block; }
    .notif-dropdown { position: absolute; top: 60px; right: -80px; width: 320px; background: #020617; border: 1px solid #1f2937; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 100; display: none; }
    .notif-dropdown.active { display: block; }
    .notif-header { padding: 12px 14px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center; }
    .notif-title { font-size: 14px; font-weight: 600; color: #e5e7eb; }
    .notif-mark-btn { font-size: 11px; color: #38bdf8; cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 1px solid #38bdf8; background: transparent; transition: all 0.2s ease; }
    .notif-mark-btn:hover { background: rgba(56, 189, 248, 0.1); }
    .notif-list { max-height: 280px; overflow-y: auto; }
    .notif-item { padding: 10px 14px; border-bottom: 1px solid #111827; color: #9ca3af; font-size: 12px; line-height: 1.5; }
    .notif-item:last-child { border-bottom: none; }
    .notif-item-msg { color: #22c55e; font-weight: 500; margin-bottom: 3px; }
    .notif-item-time { color: #6b7280; font-size: 11px; }
    .notif-empty { padding: 20px; text-align: center; color: #6b7280; font-size: 12px; }
    .main-shell { min-height: calc(100vh - 64px); padding-top: 8px; padding-bottom: 200px; display: flex; justify-content: center; align-items: flex-start; }
    .footer-section { position: relative; margin-top: -160px; padding-top: 40px; padding-bottom: 56px; background: #020617; border-top: 1px solid #0f172a; }
    .footer-section-inner { max-width: 1120px; margin: 0 auto; display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 32px; font-size: 13px; color: #9ca3af; padding: 0 20px; }
    .footer-column-title { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 12px; color: #e5e7eb; }
    .footer-link-list { display: flex; flex-direction: column; gap: 6px; }
    .footer-section-link { color: #9ca3af; text-decoration: none; transition: color 0.2s ease; }
    .footer-section-link:hover { color: #e5e7eb; }
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 64px; background: rgba(2, 6, 23, 0.98); border-top: 1px solid rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); z-index: 40; font-size: 12px; color: #9ca3af; display: flex; align-items: center; justify-content: center; }
    .bottom-inner { max-width: 1120px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
    .bottom-left, .bottom-center, .bottom-right { display: flex; align-items: center; gap: 16px; }
    .bottom-center { flex: 1; justify-content: center; text-align: center; }
    .bottom-center span { font-weight: 600; color: #e5e7eb; }
    .bottom-link { color: #9ca3af; text-decoration: none; padding: 4px 8px; border-radius: 6px; transition: all 0.2s ease; cursor: pointer; white-space: nowrap; }
    .bottom-link:hover { background: #0b1220; color: #e5e7eb; }
    .bottom-left span, .bottom-right span { opacity: 0.9; }
    .bottom-left span:first-child { font-weight: 600; color: #e5e7eb; }
    .top-logo-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  filter: drop-shadow(0 0 12px rgba(56, 189, 248, 0.6));
  transition: all 0.3s ease;
}

.top-left a:hover .top-logo-icon {
  filter: drop-shadow(0 0 18px rgba(56, 189, 248, 0.9));
  transform: scale(1.05);
}

    {% block extra_css %}{% endblock %}
  </style>
</head>
<body>
  <header class="top-bar">
<div class="top-left">
  <a href="/" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
    <div class="top-logo-icon">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="vGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#38bdf8;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#6366f1;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#a855f7;stop-opacity:1" />
          </linearGradient>
        </defs>
        <path d="M16 2 L28 12 L22 30 L10 30 L4 12 Z" fill="url(#vGradient)" stroke="url(#vGradient)" stroke-width="1.5"/>
        <text x="16" y="22" font-family="system-ui" font-size="18" font-weight="800" fill="white" text-anchor="middle">V</text>
      </svg>
    </div>
    <span style="font-size: 22px; font-weight: 700; letter-spacing: -0.02em; background: linear-gradient(135deg, #38bdf8, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Project V</span>
  </a>
</div>

    <nav class="top-nav">
      <a href="/">Assistant</a>
      <a href="/automation" class="active">Automation</a>
      <a href="/chat">Chat</a>
      <div class="bell-container">
        <button class="top-bell" onclick="toggleNotificationDropdown()" title="Notifications">
          ðŸ””
          <div class="top-bell-dot" id="bellDot"></div>
        </button>
        <div class="notif-dropdown" id="notifDropdown">
          <div class="notif-header">
            <span class="notif-title">Notifications</span>
            <button class="notif-mark-btn" onclick="markAllAsRead()">Mark all as read</button>
          </div>
          <div class="notif-list" id="notifListDropdown">
            <div class="notif-empty">Loading notifications...</div>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="main-shell">
    {% block content %}{% endblock %}
  </main>

  <section class="footer-section">
    <div class="footer-section-inner">
      <div>
        <div class="footer-column-title">Project V</div>
        <div class="footer-link-list">
          <span>Automation studio for monitoring any public page and alerting you when conditions are met.</span>
          <span style="margin-top: 8px; font-size: 11px; opacity: 0.8;">âš¡ Real-time notifications powered by AI</span>
        </div>
      </div>
      <div>
        <div class="footer-column-title">Product</div>
        <div class="footer-link-list">
          <a href="/automation" class="footer-section-link">Automation Dashboard</a>
          <a href="/status" class="footer-section-link">System Status</a>
          <a href="/pricing" class="footer-section-link">Plans &amp; Limits</a>
          <a href="/changelog" class="footer-section-link">Changelog</a>
        </div>
      </div>
      <div>
        <div class="footer-column-title">Resources</div>
        <div class="footer-link-list">
          <a href="/docs" class="footer-section-link">Documentation</a>
          <a href="/examples" class="footer-section-link">Examples</a>
          <a href="/support" class="footer-section-link">Support</a>
          <a href="/contact" class="footer-section-link">Contact</a>
        </div>
      </div>
    </div>
  </section>

  <footer class="bottom-bar">
    <div class="bottom-inner">
      <div class="bottom-left">
        <span>Project V</span>
        <a href="/automation" class="bottom-link">Status</a>
        <a href="/docs" class="bottom-link">Docs</a>
        <a href="/support" class="bottom-link">Support</a>
      </div>
      <div class="bottom-center">
        <span>All Rights Reserved by TP Vardhan</span>
      </div>
      <div class="bottom-right">
        <span>v1.0</span>
        <a href="/privacy" class="bottom-link">Privacy Policy</a>
        <a href="/terms" class="bottom-link">Terms of Use</a>
      </div>
    </div>
  </footer>
  <script>
    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notifDropdown');
      const isActive = dropdown.classList.contains('active');
      
      if (!isActive) {
        dropdown.classList.add('active');
        loadNotifications();
      } else {
        dropdown.classList.remove('active');
      }
    }

    function updateBellBadge() {
      const bellDot = document.getElementById('bellDot');
      const notifList = document.getElementById('notifListDropdown');
      const items = notifList.querySelectorAll('.notif-item');
      
      if (items.length > 0) {
        bellDot.classList.add('active');
      } else {
        bellDot.classList.remove('active');
      }
    }

    async function loadNotifications() {
      try {
        const res = await fetch('/api/notifications');
        if (!res.ok) {
          console.log('Fetch error:', res.status);
          return;
        }
        
        const data = await res.json();
        console.log('API Response:', data);
        
        let items = Array.isArray(data) ? data : (data.items || []);
        
        // FILTER ONLY UNREAD NOTIFICATIONS (read = false or read = 0)
        items = items.filter(n => !n.read);
        
        // Sort by newest first
        items = items.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        const notifListDropdown = document.getElementById('notifListDropdown');
        notifListDropdown.innerHTML = '';
        
        if (items.length === 0) {
          notifListDropdown.innerHTML = '<div class="notif-empty">No new notifications</div>';
        } else {
          items.forEach((n) => {
            const div = document.createElement('div');
            div.className = 'notif-item';
            const message = n.message || 'New notification';
            const time = n.created_at || new Date().toLocaleString();
            div.innerHTML = `<div class="notif-item-msg">âœ“ ${message}</div><div class="notif-item-time">${time}</div>`;
            notifListDropdown.appendChild(div);
          });
        }
        
        updateBellBadge();
      } catch (err) {
        console.log('Error loading notifications:', err);
        document.getElementById('notifListDropdown').innerHTML = '<div class="notif-empty">Error loading notifications</div>';
      }
    }

    async function markAllAsRead() {
      try {
        const res = await fetch('/api/notifications/mark-read', { method: 'POST' });
        if (res.ok) {
          document.getElementById('notifListDropdown').innerHTML = '<div class="notif-empty">No new notifications</div>';
          document.getElementById('bellDot').classList.remove('active');
        }
      } catch (err) {
        console.log('Error marking as read:', err);
      }
    }

    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('notifDropdown');
      const bellContainer = event.target.closest('.bell-container');
      if (!bellContainer && dropdown.classList.contains('active')) {
        dropdown.classList.remove('active');
      }
    });

    // Load notifications on page load
    window.addEventListener('load', function() {
      loadNotifications();
    });

    // Refresh notifications every 5 seconds
    setInterval(loadNotifications, 5000);
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
