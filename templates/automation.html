{% extends "base.html" %}
{% block title %}Project V ‚Äì Automation{% endblock %}
{% block extra_css %}
.page-shell { max-width: 1180px; margin: 0 auto; padding: 80px 24px 32px; }
.page-shell-header { margin-top: 0; margin-bottom: 16px; }
.page-shell-header > div:first-child { font-size: 32px; font-weight: 700; margin-bottom: 8px; color: #f3f4f6; }
.page-shell-header > div:last-child { font-size: 15px; color: #9ca3af; max-width: 640px; line-height: 1.5; }
.grid { display: grid; grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr); gap: 32px; align-items: flex-start; }
.card { border-radius: 16px; background: #020617; border: 1px solid #1f2937; padding: 18px 22px 16px; box-shadow: 0 20px 40px rgba(15,23,42,0.7); min-height: 280px; }
.card-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; color: #e5e7eb; }
.card-sub { font-size: 14px; color: #9ca3af; margin-bottom: 12px; line-height: 1.5; }
.field-group { margin-bottom: 12px; }
.field-label, .fields-label { font-size: 13px; color: #9ca3af; margin-bottom: 6px; font-weight: 500; }
.field-input, .field-textarea { width: 100%; border-radius: 10px; border: 1px solid #1f2937; background: #020617; color: #e5e7eb; padding: 11px 13px; font-size: 14px; outline: none; transition: all 0.2s ease; }
.field-textarea { min-height: 100px; resize: vertical; font-family: 'Courier New', monospace; }
.field-input::placeholder, .field-textarea::placeholder { color: #6b7280; }
.field-input:focus, .field-textarea:focus { border-color: #38bdf8; background: #0f1729; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1); }
.btn-primary { margin-top: 12px; padding: 11px 24px; border-radius: 999px; border: none; background: linear-gradient(135deg, #38bdf8, #6366f1); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; width: 100%; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(56, 189, 248, 0.3); }
.status { margin-top: 8px; font-size: 13px; color: #9ca3af; }
.table-wrapper { margin-top: 12px; border-radius: 12px; border: 1px solid #111827; overflow: hidden; background: #020617; }
.table-header { max-height: 44px; overflow: hidden; }
.table-scroll { max-height: 270px; overflow-y: auto; overflow-x: auto; }
.table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
.table th { padding: 10px 10px; border-bottom: 2px solid #1f2937; text-align: left; color: #9ca3af; font-weight: 600; background: rgba(15, 23, 42, 0.9); position: sticky; top: 0; z-index: 2; }
.table td { padding: 10px 10px; border-bottom: 1px solid #111827; color: #e5e7eb; word-wrap: break-word; vertical-align: top; }
.table tr:hover { background: rgba(15, 23, 42, 0.3); }
.table-actions { display: flex; gap: 6px; flex-wrap: wrap; }
.action-btn { padding: 5px 10px; font-size: 11px; border-radius: 6px; border: 1px solid #374151; background: #020617; color: #e5e7eb; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
.action-btn:hover { border-color: #38bdf8; color: #38bdf8; }
.action-btn.danger { border-color: #dc2626; color: #fca5a5; }
.action-btn.danger:hover { background: rgba(220, 38, 38, 0.1); }
.badge-active { padding: 4px 10px; border-radius: 999px; background: rgba(56,189,248,0.15); color: #38bdf8; font-size: 12px; font-weight: 500; }
.badge-completed { padding: 4px 10px; border-radius: 999px; background: rgba(34,197,94,0.15); color: #22c55e; font-size: 12px; font-weight: 500; }
.badge-paused { padding: 4px 10px; border-radius: 999px; background: rgba(148,163,184,0.15); color: #9ca3af; font-size: 12px; font-weight: 500; }
.badge-triggered { padding: 4px 10px; border-radius: 999px; background: rgba(34,197,94,0.15); color: #22c55e; font-size: 12px; font-weight: 500; }
.notif-list-local { margin-top: 8px; font-size: 13px; max-height: 80px; overflow-y: auto; border-top: 1px solid #1f2937; padding-top: 8px; }
.notif-item-local { padding: 6px 0; border-bottom: 1px dashed #1f2937; line-height: 1.4; }
.notif-item-local:last-child { border-bottom: none; }
.notif-time-local { color: #6b7280; font-size: 11px; margin-top: 2px; }
.status-help { margin-top: 12px; font-size: 12px; color: #6b7280; line-height: 1.6; }
.note-hard { color: #fde68a; font-weight: 500; }
.note-easy { color: #86efac; font-weight: 500; }
.optional-details-section { margin-top: 12px; margin-bottom: 12px; padding: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 12px; border: 1px solid #1f2937; }
.optional-details-label { font-size: 12px; color: #9ca3af; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.optional-fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.optional-field { display: flex; flex-direction: column; }
.optional-field label { font-size: 12px; color: #9ca3af; margin-bottom: 4px; font-weight: 500; }
.optional-field input { width: 100%; padding: 8px 10px; border: 1px solid #374151; border-radius: 8px; background: #0f1729; color: #e5e7eb; font-size: 12px; outline: none; transition: all 0.2s ease; }
.optional-field input::placeholder { color: #4b5563; }
.optional-field input:focus { border-color: #38bdf8; background: #1a2642; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1); }
@media (max-width: 1200px) { .page-shell { padding: 16px 16px 32px; } .grid { grid-template-columns: 1fr; gap: 20px; } .optional-fields-grid { grid-template-columns: 1fr; } .table-scroll { max-height: 260px; } }
{% endblock %}
{% block content %}
<div class="page-shell">
<div class="page-shell-header">
<div>Automation dashboard</div>
<div>Describe what you want in plain language and Project‚ÄëV will create an automation task to monitor and notify you when conditions are met.</div>
</div>
<div class="grid">
<section class="card">
<div class="card-title">Create automation</div>
<div class="card-sub">Example: "Alert me when RRR tickets open on BookMyShow Chennai every 15 minutes."</div>
<div class="field-group">
<div class="fields-label">What to watch for?</div>
<textarea id="auto-description" class="field-textarea" placeholder="Describe your automation in one or two sentences..."></textarea>
<div id="auto-hint" class="status"></div>
</div>
<div class="optional-details-section">
<div class="optional-details-label">Optional details</div>
<div class="optional-fields-grid">
<div class="optional-field"><label for="auto-url">Target URL</label><input id="auto-url" type="url" placeholder="https://example.com/page"></div>
<div class="optional-field"><label for="auto-keyword">Keyword to watch</label><input id="auto-keyword" type="text" placeholder="Specific text to find"></div>
<div class="optional-field"><label for="auto-frequency">Check frequency (minutes)</label><input id="auto-frequency" type="number" min="1" placeholder="15"></div>
<div class="optional-field"><label for="auto-contact">Contact / Note</label><input id="auto-contact" type="text" placeholder="Your email or note"></div>
</div>
</div>
<button class="btn-primary" id="auto-submit">Create automation</button>
<div id="auto-status" class="status"></div>
<button id="test-notify-btn" style="margin-top:10px;width:100%;font-size:12px;padding:8px;border-radius:8px;border:1px solid #1f2937;background:#020617;color:#9ca3af;cursor:pointer;transition:all .2s;">üîî Test notification</button>
<div class="field-group" style="margin-top:12px;">
<div class="field-label">Latest notifications</div>
<div id="notif-list-local" class="notif-list-local"><div class="notif-item-local"><span class="notif-time-local">No notifications yet.</span></div></div>
</div>
</section>
<section class="card">
<div class="card-title">Active automations</div>
<div class="card-sub">Project‚ÄëV monitors and notifies when conditions are met. Tasks stop after first trigger.</div>
<div class="table-wrapper">
<div class="table-header">
<table class="table">
<thead>
<tr>
<th style="width:56px;">ID</th>
<th style="width:32%;">Description</th>
<th style="width:90px;">Status</th>
<th style="width:70px;">Freq</th>
<th style="width:34%;">Last event</th>
<th style="width:120px;">Actions</th>
</tr>
</thead>
</table>
</div>
<div class="table-scroll">
<table class="table">
<tbody id="auto-table-body">
{% for a in automations %}
<tr>
<td><strong>#{{ a.id }}</strong></td>
<td>{{ a.description[:50] }}{% if a.description|length > 50 %}...{% endif %}</td>
<td>{% if a.status == 'completed' %}<span class="badge-completed">‚úì Completed</span>{% elif a.status == 'paused' %}<span class="badge-paused">‚è∏ Paused</span>{% else %}<span class="badge-active">‚óè Active</span>{% endif %}</td>
<td>{{ a.frequency_minutes or 15 }}min</td>
<td><span style="font-size:12px;color:#9ca3af;">{{ a.last_checked or '‚Äî' }}</span></td>
<td><div class="table-actions"><button class="action-btn" onclick="debugAutomation({{ a.id }})" title="Debug">Debug</button><button class="action-btn" onclick="toggleAutomation({{ a.id }})" title="Toggle">{% if a.status == 'paused' %}Resume{% else %}Pause{% endif %}</button><button class="action-btn danger" onclick="deleteAutomation({{ a.id }})" title="Delete">Delete</button></div></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
<div class="status-help"><strong>Status guide:</strong><br>‚óè <strong>Active</strong> ‚Äî Monitoring in progress<br>‚úì <strong>Completed</strong> ‚Äî Condition found, task stopped<br>‚è∏ <strong>Paused</strong> ‚Äî Monitoring paused by you</div>
</section>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const descEl=document.getElementById("auto-description"),statusEl=document.getElementById("auto-status"),submitBtn=document.getElementById("auto-submit"),notifListLocal=document.getElementById("notif-list-local"),testNotifyBtn=document.getElementById("test-notify-btn"),hintEl=document.getElementById("auto-hint"),freqEl=document.getElementById("auto-frequency"),urlEl=document.getElementById("auto-url"),keywordEl=document.getElementById("auto-keyword"),contactEl=document.getElementById("auto-contact");function updateInstructionHint(){const e=(descEl.value||"").toLowerCase().trim();e?e.includes("upsc")||e.includes("ssc")||e.includes("cgl")||e.includes("chsl")?(hintEl.textContent="‚úì Good fit: Official exam / government sites usually work well with Project‚ÄëV.",hintEl.className="status note-easy"):e.includes("bookmyshow")||e.includes("book my show")||e.includes("amazon")||e.includes("flipkart")||e.includes("myntra")||e.includes("swiggy")||e.includes("zomato")?(hintEl.textContent="‚ö† Some commercial sites may block automated checks. If blocked, you'll see HTTP 403 error.",hintEl.className="status note-hard"):(hintEl.textContent="üí° Works best with public pages that don't require login or captcha.",hintEl.className="status"):(hintEl.textContent="",hintEl.className="status")}descEl.addEventListener("input",updateInstructionHint),updateInstructionHint(),submitBtn.onclick=async()=>{const e=descEl.value.trim();if(!e)return void(statusEl.textContent="Please enter an instruction.");const t={instruction:e},a=(freqEl.value||"").trim();a&&(t.frequency_minutes=Number(a));const n=(urlEl.value||"").trim();n&&(t.target_url=n);const i=(keywordEl.value||"").trim();i&&(t.keyword=i);const o=(contactEl.value||"").trim();o&&(t.contact=o),statusEl.textContent="Creating automation...";try{const e=await fetch("/api/automation/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();if(!e.ok||!a.success)return void(statusEl.textContent="Error: "+(a.error||"Unknown error occurred"));statusEl.textContent="‚úì Automation created successfully!",descEl.value="",freqEl.value="",urlEl.value="",keywordEl.value="",contactEl.value="",updateInstructionHint(),setTimeout(()=>{window.location.reload()},1e3)}catch(e){statusEl.textContent="Network error: "+e.message}};function formatStatus(e){return e?"pending"===e?"Waiting for first check":"not_found"===e?"‚úì Checked, not found yet":"triggered"===e?"‚úì TRIGGERED - Keyword found!":"error"===e?"‚ö† Network error, retrying":e.startsWith("http_403")?"üîí Site blocked automated access (HTTP 403)":e.startsWith("http_5")?"‚ö† Server error: HTTP "+e.replace("http_",""):e.startsWith("http_")?"‚ö† HTTP "+e.replace("http_",""):e:"‚Äî"}async function ensureNotificationPermission(){return"Notification"in window&&("granted"===Notification.permission||"denied"!==Notification.permission&&"granted"===(await Notification.requestPermission()))}async function refreshLocalNotifications(){try{const e=await fetch("/api/notifications");if(!e.ok)return;let t=await e.json();const a=Array.isArray(t)?t:t.items||[];if(notifListLocal.innerHTML="",0===a.length)notifListLocal.innerHTML='<div class="notif-item-local"><span class="notif-time-local">No notifications yet.</span></div>';else{a.forEach(e=>{const t=document.createElement("div");t.className="notif-item-local",t.innerHTML=`<div style="color: #22c55e; font-weight: 500;">‚úì ${e.message}</div><div class="notif-time-local">${e.created_at}</div>`,notifListLocal.appendChild(t)});const e=await ensureNotificationPermission();e&&a.forEach(e=>{let t="üéØ Project V ‚Äì Task Triggered!",a=e.message;if("string"==typeof a&&a.includes("||")){const e=a.split("||");t=e[0]||t,a=e[1]||e[0]||a}new Notification(t,{body:a,icon:"/static/icon.png",tag:"project-v-notification",requireInteraction:!1})}),a.length>0&&await fetch("/api/notifications/mark-read",{method:"POST"})}if(window.loadNotificationsFromBell){loadNotificationsFromBell()}}catch(e){console.log("notification error",e)}}async function refreshAutomationTable(){try{const e=await fetch("/api/automations");if(!e.ok)return;const t=await e.json(),a=t.items||[],n=document.getElementById("auto-table-body");n&&(n.innerHTML="",a.forEach(e=>{const t="completed"===e.status?'<span class="badge-completed">‚úì Completed</span>':"paused"===e.status?'<span class="badge-paused">‚è∏ Paused</span>':'<span class="badge-active">‚óè Active</span>',a="paused"===e.status?"Resume":"Pause",i=formatStatus(e.last_status),o=document.createElement("tr");o.innerHTML=`<td><strong>#${e.id}</strong></td><td>${e.description.substring(0,50)}${e.description.length>50?"...":""}</td><td>${t}</td><td>${e.frequency_minutes||15}min</td><td style="font-size: 12px; color: #9ca3af;">${i}</td><td><div class="table-actions"><button class="action-btn" onclick="debugAutomation(${e.id})" title="View details">Debug</button><button class="action-btn" onclick="toggleAutomation(${e.id})" title="Pause/Resume">${a}</button><button class="action-btn danger" onclick="deleteAutomation(${e.id})" title="Delete">Delete</button></div></td>`,n.appendChild(o)}))}catch(e){console.log("table error",e)}}async function debugAutomation(e){try{const t=await fetch(`/api/automation/${e}/details`);if(!t.ok)return void alert(`Debug failed for #${e}: HTTP ${t.status}`);const a=await t.json(),n=[`üìã Automation #${a.id}`,``,"Description: "+a.description,"URL: "+(a.url||"(auto-detected)"),"Keyword: "+a.keyword,"Status: "+a.status,"Last Status: "+a.last_status,"Last Check: "+a.last_checked,`Frequency: ${a.frequency_minutes||15} minutes`].join("\n");alert(n)}catch(t){console.error("debug error",t),alert("Debug error, check console.")}}async function toggleAutomation(e){try{const t=await fetch(`/api/automation/${e}/toggle`,{method:"POST"});if(!t.ok)return void alert(`Toggle failed for #${e}: HTTP ${t.status}`);await refreshAutomationTable()}catch(t){console.error("toggle error",t),alert("Toggle error, check console.")}}async function deleteAutomation(e){if(!confirm(`Are you sure you want to delete automation #${e}?`))return;try{const t=await fetch(`/api/automation/${e}`,{method:"DELETE"});if(!t.ok)return void alert(`Delete failed for #${e}: HTTP ${t.status}`);await refreshAutomationTable()}catch(t){console.error("delete error",t),alert("Delete error, check console.")}}testNotifyBtn&&(testNotifyBtn.onclick=async()=>{try{if(!await ensureNotificationPermission())return void alert("Notifications are blocked. Enable them in browser settings.");new Notification("üéØ Project V ‚Äì Test Notification",{body:"Example: UPSC Interview Schedule notification triggered!",icon:"/static/icon.png",tag:"project-v-test"})}catch(e){console.log("notification error",e),alert("Could not show notification. Check console.")}}),refreshLocalNotifications(),refreshAutomationTable(),setInterval(refreshLocalNotifications,2e4),setInterval(refreshAutomationTable,2e4);
</script>
{% endblock %}
